{{- if .Values.rbac.create }}
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  labels:
    {{- include "bindy.labels" . | nindent 4 }}
  name: {{ include "bindy.fullname" . }}
rules:
  # Bind9Instance resources
  - apiGroups: ["bindy.firestoned.io"]
    resources: ["bind9instances", "bind9instances/status"]
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
    # Permissions needed:
    # - "get", "list", "watch": Read instances for status updates
    # - "create": Create instances for Bind9Cluster scaling
    # - "update", "patch": Update instance configuration
    # - "delete": Scale down instances (Bind9Cluster reconciler) and finalizer cleanup

  # Bind9Cluster resources
  - apiGroups: ["bindy.firestoned.io"]
    resources: ["bind9clusters", "bind9clusters/status"]
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
    # Permissions needed:
    # - "get", "list", "watch": Read clusters for status updates
    # - "create": Create clusters for Bind9GlobalCluster
    # - "update", "patch": Update cluster configuration
    # - "delete": Clean up clusters (Bind9GlobalCluster finalizer cleanup)

  # Bind9GlobalCluster resources - cluster-scoped, NO DELETE (least privilege)
  - apiGroups: ["bindy.firestoned.io"]
    resources: ["bind9globalclusters", "bind9globalclusters/status"]
    verbs: ["get", "list", "watch", "create", "update", "patch"]
    # Removed: "delete" - Use bindy-admin-role for deletions

  # DNSZone resources - NO DELETE (least privilege)
  - apiGroups: ["bindy.firestoned.io"]
    resources: ["dnszones", "dnszones/status"]
    verbs: ["get", "list", "watch", "create", "update", "patch"]
    # Removed: "delete" - Use bindy-admin-role for deletions

  # Record resources - NO DELETE (least privilege)
  - apiGroups: ["bindy.firestoned.io"]
    resources:
      - "arecords"
      - "arecords/status"
      - "aaaarecords"
      - "aaaarecords/status"
      - "txtrecords"
      - "txtrecords/status"
      - "cnamerecords"
      - "cnamerecords/status"
      - "mxrecords"
      - "mxrecords/status"
      - "nsrecords"
      - "nsrecords/status"
      - "srvrecords"
      - "srvrecords/status"
      - "caarecords"
      - "caarecords/status"
    verbs: ["get", "list", "watch", "create", "update", "patch"]
    # Removed: "delete" - Use bindy-admin-role for deletions

  # Kubernetes Deployments
  - apiGroups: ["apps"]
    resources: ["deployments"]
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
    # Permissions needed:
    # - "get", "list", "watch": Read deployment status
    # - "create": Create deployments for Bind9Instance
    # - "update", "patch": Update deployment configuration
    # - "delete": Finalizer cleanup (Bind9Instance reconciler)
    # Note: Owner references provide automatic GC, but finalizer explicitly deletes

  # Kubernetes Services
  - apiGroups: [""]
    resources: ["services"]
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
    # Permissions needed:
    # - "get", "list", "watch": Read service status and endpoints
    # - "create": Create services for Bind9Instance
    # - "update", "patch": Update service configuration (preserves clusterIP)
    # - "delete": Finalizer cleanup (Bind9Instance reconciler)
    # Note: Owner references provide automatic GC, but finalizer explicitly deletes

  # Kubernetes ConfigMaps
  - apiGroups: [""]
    resources: ["configmaps"]
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
    # Permissions needed:
    # - "get", "list", "watch": Read configuration data
    # - "create": Create ConfigMaps for Bind9Instance configuration
    # - "update", "patch": Update BIND9 configuration (zone changes)
    # - "delete": Finalizer cleanup (Bind9Instance reconciler)
    # Note: Owner references provide automatic GC, but finalizer explicitly deletes

  # Kubernetes Secrets - RNDC key management (CRITICAL: least privilege for sensitive data)
  - apiGroups: [""]
    resources: ["secrets"]
    verbs: ["get", "list", "watch", "create", "delete"]
    # Permissions needed:
    # - "get": Load RNDC keys for zone updates (DNSZone reconciler)
    # - "list": Check if RNDC secrets exist (Bind9Cluster reconciler)
    # - "watch": Monitor RNDC secret changes
    # - "create": Generate RNDC keys for new Bind9Instance resources
    # - "delete": Clean up RNDC keys when Bind9Instance is deleted (finalizer)
    # Removed: "update", "patch" - Secrets are immutable (delete+recreate pattern)
    # PCI-DSS 7.1.2: Minimal permissions for RNDC secret lifecycle management

  # Kubernetes ServiceAccounts
  - apiGroups: [""]
    resources: ["serviceaccounts"]
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
    # Permissions needed:
    # - "get", "list", "watch": Read service account status
    # - "create": Create service accounts for Bind9Instance pods
    # - "update", "patch": Update service account configuration
    # - "delete": Finalizer cleanup (Bind9Instance reconciler)
    # Note: Owner references provide automatic GC, but finalizer explicitly deletes

  # Kubernetes Pods - READ-ONLY (for discovery and status)
  - apiGroups: [""]
    resources: ["pods"]
    verbs: ["get", "list", "watch"]

  # Kubernetes Endpoints - READ-ONLY (for service discovery)
  - apiGroups: [""]
    resources: ["endpoints"]
    verbs: ["get", "list", "watch"]

  # Events for logging (no delete needed)
  - apiGroups: [""]
    resources: ["events"]
    verbs: ["create", "patch"]

  # Leases for leader election (no delete needed for HA)
  - apiGroups: ["coordination.k8s.io"]
    resources: ["leases"]
    verbs: ["get", "create", "update", "patch"]
{{- end }}
